<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clash Royale Tournament</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
      :root {
        --primary-color: #ff7b00;
        --secondary-color: #f5f5f5;
        --text-color: #333;
        --light-text: #777;
        --border-color: #ddd;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Roboto", sans-serif;
        color: var(--text-color);
        background-color: white;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      header {
        background-color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        padding: 15px 0;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary-color);
      }

      .auth-section {
        display: flex;
        align-items: center;
      }

      .auth-section input {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin-right: 10px;
      }

      .auth-section button {
        padding: 8px 15px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .auth-section button:hover {
        background-color: #e67300;
      }

      .admin-panel {
        display: none;
        background-color: var(--secondary-color);
        padding: 15px;
        margin: 20px 0;
        border-radius: 5px;
        border-left: 4px solid var(--primary-color);
      }

      .admin-panel h3 {
        margin-bottom: 15px;
        color: var(--primary-color);
      }

      .admin-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
      }

      .admin-section {
        flex: 1;
        min-width: 300px;
      }

      .admin-section h4 {
        margin-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 5px;
      }

      .form-group {
        margin-bottom: 10px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
      }

      .form-group button {
        padding: 8px 15px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .form-group button:hover {
        background-color: #e67300;
      }

      .tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        margin: 20px 0;
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.3s;
      }

      .tab.active {
        border-bottom: 2px solid var(--primary-color);
        color: var(--primary-color);
        font-weight: 500;
      }

      .tab:hover:not(.active) {
        background-color: var(--secondary-color);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }

      th {
        background-color: var(--secondary-color);
        font-weight: 500;
      }

      tr:hover {
        background-color: var(--secondary-color);
      }

      .player-link {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
      }

      .player-link:hover {
        text-decoration: underline;
      }

      .battle-card {
        background-color: white;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .battle-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
      }

      .battle-result {
        font-weight: 500;
        color: var(--primary-color);
      }

      .battle-date {
        color: var(--light-text);
        font-size: 14px;
      }

      .battle-players {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 20px;
      }

      .battle-player {
        flex: 1;
        min-width: 200px;
      }

      .battle-player-name {
        font-weight: 500;
        margin-bottom: 5px;
      }

      .battle-player-score {
        font-size: 14px;
        color: var(--light-text);
      }

      .battle-note {
        margin-top: 10px;
        font-style: italic;
        color: var(--light-text);
        padding-top: 10px;
        border-top: 1px solid var(--border-color);
      }

      .deck-embed {
        width: 100%;
        height: 200px;
        border: none;
        margin-top: 10px;
      }

      .rules-section {
        background-color: white;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .rules-section h3 {
        color: var(--primary-color);
        margin-bottom: 15px;
      }

      .rules-section ul {
        list-style-position: inside;
        margin-bottom: 15px;
      }

      .rules-section li {
        margin-bottom: 8px;
      }

      .game-system {
        background-color: var(--secondary-color);
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
      }

      .game-system h4 {
        color: var(--primary-color);
        margin-bottom: 10px;
      }

      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          align-items: flex-start;
        }

        .auth-section {
          margin-top: 15px;
          width: 100%;
        }

        .auth-section input {
          flex: 1;
        }

        .admin-actions {
          flex-direction: column;
        }

        .battle-players {
          flex-direction: column;
        }

        th,
        td {
          padding: 8px 10px;
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="header-content">
          <div class="logo">Clash Royale Tournament</div>
          <div class="auth-section">
            <input
              type="password"
              id="adminPassword"
              placeholder="Admin password"
            />
            <button id="loginBtn">Login</button>
            <button id="logoutBtn" style="display: none">Logout</button>
          </div>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="admin-panel" id="adminPanel">
        <h3>Admin Panel</h3>
        <div class="admin-actions">
          <div class="admin-section">
            <h4>Add/Edit Player</h4>
            <div class="form-group">
              <label for="playerTag">Player Tag (without #)</label>
              <input type="text" id="playerTag" placeholder="PlayerTag" />
            </div>
            <div class="form-group">
              <label for="playerName">Player Name</label>
              <input type="text" id="playerName" placeholder="Player Name" />
            </div>
            <div class="form-group">
              <button id="addPlayerBtn">Add/Update Player</button>
            </div>
          </div>

          <div class="admin-section">
            <h4>Add Match</h4>
            <div class="form-group">
              <label for="player1">Player 1</label>
              <select id="player1"></select>
            </div>
            <div class="form-group">
              <label for="player2">Player 2</label>
              <select id="player2"></select>
            </div>
            <div class="form-group">
              <label for="winner">Winner</label>
              <select id="winner">
                <option value="player1">Player 1</option>
                <option value="player2">Player 2</option>
                <option value="draw">Draw</option>
              </select>
            </div>
            <div class="form-group">
              <label for="player1Score">Player 1 Score</label>
              <input
                type="number"
                id="player1Score"
                min="0"
                max="3"
                value="1"
              />
            </div>
            <div class="form-group">
              <label for="player2Score">Player 2 Score</label>
              <input
                type="number"
                id="player2Score"
                min="0"
                max="3"
                value="1"
              />
            </div>
            <div class="form-group">
              <label for="matchNote">Note</label>
              <input type="text" id="matchNote" placeholder="Optional note" />
            </div>
            <div class="form-group">
              <button id="addMatchBtn">Add Match</button>
            </div>
          </div>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="leaderboard">Leaderboard</div>
        <div class="tab" data-tab="battles">Battle Log</div>
        <div class="tab" data-tab="rules">Rules</div>
      </div>

      <div class="tab-content active" id="leaderboard">
        <h2>Leaderboard</h2>
        <table id="leaderboardTable">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Player</th>
              <th>Wins</th>
              <th>Losses</th>
              <th>Matches</th>
              <th>Points</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>

      <div class="tab-content" id="battles">
        <h2>Battle Log</h2>
        <div id="battleLog"></div>
      </div>

      <div class="tab-content" id="rules">
        <div class="rules-section">
          <h3>Tournament Rules</h3>
          <ul>
            <li>
              Pro účast v lize je nutné být v klanu „4 Veteráni" nebo mít
              všechny hráče v přátelích
            </li>
            <li>Přidávání nových hráčů bez povolení founderů je zakázáno</li>
            <li>
              Během hracího dne je povinnost odehrát všechny zápasy – neodehrání
              = -3 body
            </li>
            <li>Dlouhá neaktivita = BAN podle rozhodnutí founderů</li>
            <li>V případě nejasností kontaktujte foundery</li>
          </ul>
        </div>

        <div class="game-system">
          <h4>Game System</h4>
          <ul>
            <li>Každý hráč hraje s každým jeden zápas</li>
            <li>Výhra v základní době = 3 body</li>
            <li>Výhra v overtime = 2 body</li>
            <li>Poražený v overtime = 1 bod</li>
            <li>Při rovnosti bodů rozhoduje počet zničených towerek (skóre)</li>
          </ul>
        </div>
      </div>
    </div>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAWrFEusuCUbarU9UJuI0EIpEZE3gFJGbQ",
        authDomain: "clash-royale-tournament-c7688.firebaseapp.com",
        databaseURL:
          "https://clash-royale-tournament-c7688-default-rtdb.firebaseio.com",
        projectId: "clash-royale-tournament-c7688",
        storageBucket: "clash-royale-tournament-c7688.appspot.com",
        messagingSenderId: "834565862453",
        appId: "1:834565862453:web:85b84f9c037b32f48a2d7c",
        measurementId: "G-X8YL6G1QM9",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // Admin password (in a real app, use Firebase Auth properly)
      const ADMIN_PASSWORD = "tournament123";

      // DOM elements
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const adminPassword = document.getElementById("adminPassword");
      const adminPanel = document.getElementById("adminPanel");
      const addPlayerBtn = document.getElementById("addPlayerBtn");
      const addMatchBtn = document.getElementById("addMatchBtn");
      const playerTagInput = document.getElementById("playerTag");
      const playerNameInput = document.getElementById("playerName");
      const player1Select = document.getElementById("player1");
      const player2Select = document.getElementById("player2");
      const winnerSelect = document.getElementById("winner");
      const player1ScoreInput = document.getElementById("player1Score");
      const player2ScoreInput = document.getElementById("player2Score");
      const matchNoteInput = document.getElementById("matchNote");
      const leaderboardBody = document.getElementById("leaderboardBody");
      const battleLog = document.getElementById("battleLog");
      const tabs = document.querySelectorAll(".tab");
      const tabContents = document.querySelectorAll(".tab-content");

      // State
      let players = [];
      let matches = [];
      let isAdmin = false;

      // Initialize the app
      function init() {
        checkAuth();
        setupEventListeners();
        fetchData();
      }

      // Check authentication status
      function checkAuth() {
        const savedPassword = localStorage.getItem("adminPassword");
        if (savedPassword === ADMIN_PASSWORD) {
          isAdmin = true;
          adminPanel.style.display = "block";
          loginBtn.style.display = "none";
          logoutBtn.style.display = "block";
          adminPassword.value = "";
        }
      }

      // Set up event listeners
      function setupEventListeners() {
        // Tab switching
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((t) => t.classList.remove("active"));
            tabContents.forEach((c) => c.classList.remove("active"));

            tab.classList.add("active");
            const tabId = tab.getAttribute("data-tab");
            document.getElementById(tabId).classList.add("active");
          });
        });

        // Authentication
        loginBtn.addEventListener("click", handleLogin);
        logoutBtn.addEventListener("click", handleLogout);
        adminPassword.addEventListener("keypress", (e) => {
          if (e.key === "Enter") handleLogin();
        });

        // Admin actions
        addPlayerBtn.addEventListener("click", addPlayer);
        addMatchBtn.addEventListener("click", addMatch);
      }

      // Handle login
      function handleLogin() {
        if (adminPassword.value === ADMIN_PASSWORD) {
          isAdmin = true;
          adminPanel.style.display = "block";
          loginBtn.style.display = "none";
          logoutBtn.style.display = "block";
          adminPassword.value = "";
          localStorage.setItem("adminPassword", ADMIN_PASSWORD);
        } else {
          alert("Incorrect password");
        }
      }

      // Handle logout
      function handleLogout() {
        isAdmin = false;
        adminPanel.style.display = "none";
        loginBtn.style.display = "block";
        logoutBtn.style.display = "none";
        localStorage.removeItem("adminPassword");
      }

      // Fetch data from Firebase
      function fetchData() {
        // Fetch players
        database.ref("players").on("value", (snapshot) => {
          players = [];
          const data = snapshot.val();
          if (data) {
            Object.keys(data).forEach((key) => {
              players.push({ id: key, ...data[key] });
            });
            updatePlayerSelects();
            renderLeaderboard();
          }
        });

        // Fetch matches
        database.ref("matches").on("value", (snapshot) => {
          matches = [];
          const data = snapshot.val();
          if (data) {
            Object.keys(data).forEach((key) => {
              matches.push({ id: key, ...data[key] });
            });
            renderBattleLog();
          }
        });
      }

      // Add or update a player
      function addPlayer() {
        const tag = playerTagInput.value.trim();
        const name = playerNameInput.value.trim();

        if (!tag || !name) {
          alert("Please enter both player tag and name");
          return;
        }

        // Check if player already exists
        const existingPlayer = players.find((p) => p.tag === tag);

        if (existingPlayer) {
          // Update player
          database
            .ref(`players/${existingPlayer.id}`)
            .update({
              name: name,
            })
            .then(() => {
              alert("Player updated successfully");
              playerTagInput.value = "";
              playerNameInput.value = "";
            })
            .catch((error) => {
              alert("Error updating player: " + error.message);
            });
        } else {
          // Add new player
          const newPlayer = {
            tag: tag,
            name: name,
            wins: 0,
            losses: 0,
            matches: 0,
            points: 0,
          };

          database
            .ref("players")
            .push(newPlayer)
            .then(() => {
              alert("Player added successfully");
              playerTagInput.value = "";
              playerNameInput.value = "";
            })
            .catch((error) => {
              alert("Error adding player: " + error.message);
            });
        }
      }

      // Add a match
      function addMatch() {
        const player1Id = player1Select.value;
        const player2Id = player2Select.value;
        const winner = winnerSelect.value;
        const player1Score = parseInt(player1ScoreInput.value);
        const player2Score = parseInt(player2ScoreInput.value);
        const note = matchNoteInput.value.trim();
        const timestamp = new Date().toISOString();

        if (!player1Id || !player2Id || player1Id === player2Id) {
          alert("Please select two different players");
          return;
        }

        const player1 = players.find((p) => p.id === player1Id);
        const player2 = players.find((p) => p.id === player2Id);

        if (!player1 || !player2) {
          alert("Selected players not found");
          return;
        }

        // Calculate points based on scores
        let player1Points = 0;
        let player2Points = 0;

        if (winner === "player1") {
          if (player1Score === 3) {
            player1Points = 3; // Regular win
            player2Points = 0;
          } else {
            player1Points = 2; // Overtime win
            player2Points = 1; // Overtime loss
          }
        } else if (winner === "player2") {
          if (player2Score === 3) {
            player1Points = 0;
            player2Points = 3; // Regular win
          } else {
            player1Points = 1; // Overtime loss
            player2Points = 2; // Overtime win
          }
        } else {
          // Draw (shouldn't happen with current UI)
          player1Points = 1;
          player2Points = 1;
        }

        // Create match object
        const match = {
          player1: {
            id: player1Id,
            name: player1.name,
            tag: player1.tag,
            score: player1Score,
            points: player1Points,
          },
          player2: {
            id: player2Id,
            name: player2.name,
            tag: player2.tag,
            score: player2Score,
            points: player2Points,
          },
          winner: winner,
          note: note,
          timestamp: timestamp,
        };

        // Add match to database
        database
          .ref("matches")
          .push(match)
          .then(() => {
            // Update player stats
            updatePlayerStats(
              player1Id,
              player2Id,
              winner,
              player1Points,
              player2Points
            );

            // Clear form
            player1Select.value = "";
            player2Select.value = "";
            winnerSelect.value = "player1";
            player1ScoreInput.value = "1";
            player2ScoreInput.value = "1";
            matchNoteInput.value = "";

            alert("Match added successfully");
          })
          .catch((error) => {
            alert("Error adding match: " + error.message);
          });
      }

      // Update player stats after a match
      function updatePlayerStats(
        player1Id,
        player2Id,
        winner,
        player1Points,
        player2Points
      ) {
        const player1Ref = database.ref(`players/${player1Id}`);
        const player2Ref = database.ref(`players/${player2Id}`);

        // Get current stats
        player1Ref.once("value").then((snapshot) => {
          const player1 = snapshot.val();
          const newWins1 =
            winner === "player1" ? (player1.wins || 0) + 1 : player1.wins || 0;
          const newLosses1 =
            winner === "player2"
              ? (player1.losses || 0) + 1
              : player1.losses || 0;

          player1Ref.update({
            wins: newWins1,
            losses: newLosses1,
            matches: (player1.matches || 0) + 1,
            points: (player1.points || 0) + player1Points,
          });
        });

        player2Ref.once("value").then((snapshot) => {
          const player2 = snapshot.val();
          const newWins2 =
            winner === "player2" ? (player2.wins || 0) + 1 : player2.wins || 0;
          const newLosses2 =
            winner === "player1"
              ? (player2.losses || 0) + 1
              : player2.losses || 0;

          player2Ref.update({
            wins: newWins2,
            losses: newLosses2,
            matches: (player2.matches || 0) + 1,
            points: (player2.points || 0) + player2Points,
          });
        });
      }

      // Update player selects in match form
      function updatePlayerSelects() {
        player1Select.innerHTML = '<option value="">Select Player 1</option>';
        player2Select.innerHTML = '<option value="">Select Player 2</option>';

        players.forEach((player) => {
          const option1 = document.createElement("option");
          option1.value = player.id;
          option1.textContent = player.name;

          const option2 = document.createElement("option");
          option2.value = player.id;
          option2.textContent = player.name;

          player1Select.appendChild(option1);
          player2Select.appendChild(option2);
        });
      }

      // Render leaderboard
      function renderLeaderboard() {
        // Sort players by points (descending)
        const sortedPlayers = [...players].sort((a, b) => b.points - a.points);

        leaderboardBody.innerHTML = "";

        sortedPlayers.forEach((player, index) => {
          const row = document.createElement("tr");

          row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <a href="https://royaleapi.com/player/${
                          player.tag
                        }" class="player-link" target="_blank">
                            ${player.name}
                        </a>
                    </td>
                    <td>${player.wins || 0}</td>
                    <td>${player.losses || 0}</td>
                    <td>${player.matches || 0}</td>
                    <td>${player.points || 0}</td>
                `;

          leaderboardBody.appendChild(row);
        });
      }

      // Render battle log
      function renderBattleLog() {
        // Sort matches by timestamp (newest first)
        const sortedMatches = [...matches].sort(
          (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
        );

        battleLog.innerHTML = "";

        if (sortedMatches.length === 0) {
          battleLog.innerHTML = "<p>No matches recorded yet.</p>";
          return;
        }

        sortedMatches.forEach((match) => {
          const battleCard = document.createElement("div");
          battleCard.className = "battle-card";

          const resultText =
            match.winner === "player1"
              ? `${match.player1.name} defeated ${match.player2.name}`
              : match.winner === "player2"
              ? `${match.player2.name} defeated ${match.player1.name}`
              : `Draw between ${match.player1.name} and ${match.player2.name}`;

          const date = new Date(match.timestamp).toLocaleString();

          battleCard.innerHTML = `
                    <div class="battle-header">
                        <div class="battle-result">${resultText}</div>
                        <div class="battle-date">${date}</div>
                    </div>
                    <div class="battle-players">
                        <div class="battle-player">
                            <div class="battle-player-name">${
                              match.player1.name
                            }</div>
                            <div class="battle-player-score">Score: ${
                              match.player1.score
                            } | Points: +${match.player1.points}</div>
                            <iframe class="deck-embed" src="https://royaleapi.com/player/${
                              match.player1.tag
                            }/embed/deck?size=large"></iframe>
                        </div>
                        <div class="battle-player">
                            <div class="battle-player-name">${
                              match.player2.name
                            }</div>
                            <div class="battle-player-score">Score: ${
                              match.player2.score
                            } | Points: +${match.player2.points}</div>
                            <iframe class="deck-embed" src="https://royaleapi.com/player/${
                              match.player2.tag
                            }/embed/deck?size=large"></iframe>
                        </div>
                    </div>
                    ${
                      match.note
                        ? `<div class="battle-note">Note: ${match.note}</div>`
                        : ""
                    }
                `;

          battleLog.appendChild(battleCard);
        });
      }

      // Initialize the app
      init();
    </script>
  </body>
</html>
